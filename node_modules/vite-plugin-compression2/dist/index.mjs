import t from"node:fs/promises";import e from"fs";import i from"os";import n from"path";import{createFilter as r}from"@rollup/pluginutils";import a from"zlib";import o from"util";import{createPack as s}from"tar-mini";function l(t){return t.length}function u(t,e){let i="function"==typeof e?e(t):e,{dir:r,base:a}=n.parse(t);return i.replace(/\[path\]/,r?r+"/":"").replace(/\[base\]/,a)}function c(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function p(e){let i=await Promise.all((await t.readdir(e)).map(t=>n.join(e,t))),r=0,a=[];for(;r!==l(i);){let e=i[r],o=await t.stat(e);if(o.isDirectory()){let r=await t.readdir(e);i.push(...r.map(t=>n.join(e,t)))}o.isFile()&&a.push(e),r++}return a}let f=new TextEncoder;function d(t){return"string"==typeof t?f.encode(t):t}async function m(t,e,i){try{return await e(t,i)}catch(t){return Promise.reject(t)}}let h={gzip:{level:a.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[a.constants.BROTLI_PARAM_QUALITY]:a.constants.BROTLI_MAX_QUALITY}},deflate:{level:a.constants.Z_BEST_COMPRESSION},deflateRaw:{level:a.constants.Z_BEST_COMPRESSION}};function w(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class y{enqueue(t){this.queue.push(t),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let t=this.queue.shift();this.running++;try{await t()}catch(t){this.errors.push(t)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(t=>setTimeout(t,0));if(l(this.errors))throw AggregateError(this.errors,"task failed")}constructor(t){w(this,"maxConcurrent",void 0),w(this,"queue",void 0),w(this,"running",void 0),w(this,"errors",void 0),this.maxConcurrent=t,this.queue=[],this.errors=[],this.running=0}}let g="vite:build-import-analysis",b="vite-plugin-compression",v=(()=>{let t=i.cpus()||{length:1};return 1===t.length?10:Math.max(1,t.length-1)})();function O(t){var e;let i=new Set,r=(t,e)=>c(n.resolve(t,e));return(null===(e=t.build.rollupOptions)||void 0===e?void 0:e.output)?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(e=>{("object"!=typeof e||l(Object.keys(e)))&&i.add(r(t.root,e.dir||t.build.outDir))}):i.add(r(t.root,t.build.outDir)),i}async function P(t,e){let i=t.generateBundle;if("object"==typeof i&&i.handler){let t=i.handler;i.handler=async function(...i){await t.apply(this,i),await e.apply(this,i)}}"function"==typeof i&&(t.generateBundle=async function(...t){await i.apply(this,t),await e.apply(this,t)})}async function j(t,i){let r=!("copyPublicDir"in t.build)||t.build.copyPublicDir;if(t.publicDir&&r&&e.existsSync(t.publicDir)){let e=await p(t.publicDir),r=n.join(t.root,n.relative(t.root,t.publicDir));await Promise.all(e.map(async t=>{let e=c(n.relative(r,t));await i(e,t)}))}}function S(i={}){let r;let{dest:a}=i,o=[],l=[],u=[],p=process.cwd(),f=function(){let t=s(),i={dests:[],root:""};return{add:e=>{t.add(d(e.content),{filename:e.filename})},write:()=>Promise.all(i.dests.map(r=>{let a=c(n.resolve(i.root,r+".tar")),o=c(n.dirname(a));return i.root!==o&&e.mkdirSync(o,{recursive:!0}),new Promise((i,n)=>{let r=e.createWriteStream(a);r.on("error",n),r.on("finish",i),t.receiver.pipe(r)})})),setOptions:t=>Object.assign(i,t)}}(),m=new y(v);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(t){if(l.push(...O(t)),p=t.root,u=a?[a]:l,f.setOptions({dests:u,root:p}),(r=B.getPluginAPI(t.plugins))||await j(t,async t=>{o.push(t)}),!t.plugins.find(t=>t.name===g))throw Error("[vite-plugin-tarball] can't be work in versions lower than vite at 2.0.0")},async writeBundle(t,e){for(let t in e){let i=e[t];f.add({filename:t,content:"asset"===i.type?i.source:i.code})}},async closeBundle(){for(let e of(!o.length&&r&&r.staticOutputs.size&&o.push(...r.staticOutputs),l))for(let i of o)m.enqueue(async()=>{let r=n.join(e,i),a=await t.readFile(r);f.add({filename:i,content:a})});await m.wait(),await f.write()}}}function B(e={}){let{include:i=/\.(html|xml|css|json|js|mjs|svg|yaml|yml|toml)$/,exclude:s,threshold:c=0,algorithm:p="gzip",filename:f,compressionOptions:w,deleteOriginalAssets:S=!1,skipIfLargerOrEqual:E=!0}=e,A=r(i,s),C=[],R=[],_=Object.create(null);_.algorithm="string"==typeof p?function(t){let e=t in a?t:"gzip";return{algorithm:o.promisify(a[e])}}(p).algorithm:p,_.options="function"==typeof p?w:Object.assign(h[p],w),_.filename=null!=f?f:"brotliCompress"===p?"[path][base].br":"[path][base].gz";let q=new y(v),D=async function(t,e){for(let t in e){if(!A(t))continue;let i=e[t],n=d("asset"===i.type?i.source:i.code),r=l(n);r<c||q.enqueue(async()=>{let i=u(t,_.filename),a=await m(n,_.algorithm,_.options);E&&l(a)>=r||((S||t===i)&&Reflect.deleteProperty(e,t),this.emitFile({type:"asset",fileName:i,source:a}))})}await q.wait().catch(this.error)},I={staticOutputs:new Set},T=null,x={name:b,apply:"build",enforce:"post",api:I,options(){let{rollupVersion:t}=this.meta,[e,i]=t.split(".");if(2>+e&&78>+i){P(T,D);return}x.generateBundle={order:"post",handler:D}},async configResolved(t){if(R.push(...O(t)),await j(t,async t=>{C.push(t)}),!(T=t.plugins.find(t=>t.name===g)))throw Error("[vite-plugin-compression] Can't be work in versions lower than vite at 2.0.0")},async closeBundle(){for(let e of R)for(let i of C)q.enqueue(async()=>{let r=n.join(e,i);if(A(r)||I.staticOutputs.has(i)){let{size:a}=await t.stat(r);if(a<c)I.staticOutputs.has(i)||I.staticOutputs.add(i);else{let a=await t.readFile(r),o=await m(a,_.algorithm,_.options);if(E&&l(o)>=l(a))return;let s=u(i,_.filename);I.staticOutputs.has(s)||I.staticOutputs.add(s);let c=n.join(e,s);S&&c!==r&&await t.rm(r,{recursive:!0,force:!0}),await t.writeFile(c,o)}}else I.staticOutputs.add(i)});await q.wait().catch(t=>t)}};return x}function E(t){return t}B.getPluginAPI=t=>{var e;return null===(e=t.find(t=>t.name===b))||void 0===e?void 0:e.api};export{B as compression,B as default,E as defineCompressionOption,S as tarball};
