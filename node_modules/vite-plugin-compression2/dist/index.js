"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("node:fs/promises"),e=require("fs"),i=require("os"),r=require("path"),n=require("@rollup/pluginutils"),a=require("zlib"),s=require("util"),o=require("tar-mini");function l(t){return t.length}function u(t,e){let i="function"==typeof e?e(t):e,{dir:n,base:a}=r.parse(t);return i.replace(/\[path\]/,n?n+"/":"").replace(/\[base\]/,a)}function c(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function p(e){let i=await Promise.all((await t.readdir(e)).map(t=>r.join(e,t))),n=0,a=[];for(;n!==l(i);){let e=i[n],s=await t.stat(e);if(s.isDirectory()){let n=await t.readdir(e);i.push(...n.map(t=>r.join(e,t)))}s.isFile()&&a.push(e),n++}return a}const f=new TextEncoder;function d(t){return"string"==typeof t?f.encode(t):t}async function h(t,e,i){try{return await e(t,i)}catch(t){return Promise.reject(t)}}const m={gzip:{level:a.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[a.constants.BROTLI_PARAM_QUALITY]:a.constants.BROTLI_MAX_QUALITY}},deflate:{level:a.constants.Z_BEST_COMPRESSION},deflateRaw:{level:a.constants.Z_BEST_COMPRESSION}};function y(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class w{enqueue(t){this.queue.push(t),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let t=this.queue.shift();this.running++;try{await t()}catch(t){this.errors.push(t)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(t=>setTimeout(t,0));if(l(this.errors))throw AggregateError(this.errors,"task failed")}constructor(t){y(this,"maxConcurrent",void 0),y(this,"queue",void 0),y(this,"running",void 0),y(this,"errors",void 0),this.maxConcurrent=t,this.queue=[],this.errors=[],this.running=0}}const g="vite:build-import-analysis",b="vite-plugin-compression",v=(()=>{let t=i.cpus()||{length:1};return 1===t.length?10:Math.max(1,t.length-1)})();function O(t){var e;let i=new Set,n=(t,e)=>c(r.resolve(t,e));return(null===(e=t.build.rollupOptions)||void 0===e?void 0:e.output)?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(e=>{("object"!=typeof e||l(Object.keys(e)))&&i.add(n(t.root,e.dir||t.build.outDir))}):i.add(n(t.root,t.build.outDir)),i}async function P(t,e){let i=t.generateBundle;if("object"==typeof i&&i.handler){let t=i.handler;i.handler=async function(...i){await t.apply(this,i),await e.apply(this,i)}}"function"==typeof i&&(t.generateBundle=async function(...t){await i.apply(this,t),await e.apply(this,t)})}async function j(t,i){let n=!("copyPublicDir"in t.build)||t.build.copyPublicDir;if(t.publicDir&&n&&e.existsSync(t.publicDir)){let e=await p(t.publicDir),n=r.join(t.root,r.relative(t.root,t.publicDir));await Promise.all(e.map(async t=>{let e=c(r.relative(n,t));await i(e,t)}))}}function q(e={}){let{include:i=/\.(html|xml|css|json|js|mjs|svg|yaml|yml|toml)$/,exclude:o,threshold:c=0,algorithm:p="gzip",filename:f,compressionOptions:y,deleteOriginalAssets:S=!1,skipIfLargerOrEqual:x=!0}=e,_=n.createFilter(i,o),B=[],E=[],A=Object.create(null);A.algorithm="string"==typeof p?function(t){let e=t in a?t:"gzip";return{algorithm:s.promisify(a[e])}}(p).algorithm:p,A.options="function"==typeof p?y:Object.assign(m[p],y),A.filename=null!=f?f:"brotliCompress"===p?"[path][base].br":"[path][base].gz";let C=new w(v),R=async function(t,e){for(let t in e){if(!_(t))continue;let i=e[t],r=d("asset"===i.type?i.source:i.code),n=l(r);n<c||C.enqueue(async()=>{let i=u(t,A.filename),a=await h(r,A.algorithm,A.options);x&&l(a)>=n||((S||t===i)&&Reflect.deleteProperty(e,t),this.emitFile({type:"asset",fileName:i,source:a}))})}await C.wait().catch(this.error)},D={staticOutputs:new Set},I=null,T={name:b,apply:"build",enforce:"post",api:D,options(){let{rollupVersion:t}=this.meta,[e,i]=t.split(".");if(2>+e&&78>+i){P(I,R);return}T.generateBundle={order:"post",handler:R}},async configResolved(t){if(E.push(...O(t)),await j(t,async t=>{B.push(t)}),!(I=t.plugins.find(t=>t.name===g)))throw Error("[vite-plugin-compression] Can't be work in versions lower than vite at 2.0.0")},async closeBundle(){for(let e of E)for(let i of B)C.enqueue(async()=>{let n=r.join(e,i);if(_(n)||D.staticOutputs.has(i)){let{size:a}=await t.stat(n);if(a<c)D.staticOutputs.has(i)||D.staticOutputs.add(i);else{let a=await t.readFile(n),s=await h(a,A.algorithm,A.options);if(x&&l(s)>=l(a))return;let o=u(i,A.filename);D.staticOutputs.has(o)||D.staticOutputs.add(o);let c=r.join(e,o);S&&c!==n&&await t.rm(n,{recursive:!0,force:!0}),await t.writeFile(c,s)}}else D.staticOutputs.add(i)});await C.wait().catch(t=>t)}};return T}q.getPluginAPI=t=>{var e;return null===(e=t.find(t=>t.name===b))||void 0===e?void 0:e.api},exports.compression=q,exports.default=q,exports.defineCompressionOption=function(t){return t},exports.tarball=function(i={}){let n;let{dest:a}=i,s=[],l=[],u=[],p=process.cwd(),f=function(){let t=o.createPack(),i={dests:[],root:""};return{add:e=>{t.add(d(e.content),{filename:e.filename})},write:()=>Promise.all(i.dests.map(n=>{let a=c(r.resolve(i.root,n+".tar")),s=c(r.dirname(a));return i.root!==s&&e.mkdirSync(s,{recursive:!0}),new Promise((i,r)=>{let n=e.createWriteStream(a);n.on("error",r),n.on("finish",i),t.receiver.pipe(n)})})),setOptions:t=>Object.assign(i,t)}}(),h=new w(v);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(t){if(l.push(...O(t)),p=t.root,u=a?[a]:l,f.setOptions({dests:u,root:p}),(n=q.getPluginAPI(t.plugins))||await j(t,async t=>{s.push(t)}),!t.plugins.find(t=>t.name===g))throw Error("[vite-plugin-tarball] can't be work in versions lower than vite at 2.0.0")},async writeBundle(t,e){for(let t in e){let i=e[t];f.add({filename:t,content:"asset"===i.type?i.source:i.code})}},async closeBundle(){for(let e of(!s.length&&n&&n.staticOutputs.size&&s.push(...n.staticOutputs),l))for(let i of s)h.enqueue(async()=>{let n=r.join(e,i),a=await t.readFile(n);f.add({filename:i,content:a})});await h.wait(),await f.write()}}};
